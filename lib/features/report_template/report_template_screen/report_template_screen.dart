import 'dart:developer';import 'dart:io';import 'package:dotted_decoration/dotted_decoration.dart';import 'package:flutter/material.dart';import 'package:get/get.dart';import 'package:image_picker/image_picker.dart';import '../../partner/controller/partner_controller.dart';import '../controller/report_template_controller.dart';class ReportTemplateScreen extends StatefulWidget {  const ReportTemplateScreen({super.key});  @override  State<ReportTemplateScreen> createState() => _ReportTemplateScreenState();}class _ReportTemplateScreenState extends State<ReportTemplateScreen> {  String? selectedOption;  String? selectedValue;  TextEditingController reportTextEdit = TextEditingController();  final ReportTemplateController controller = Get.put(ReportTemplateController(),);  final PartnerController partnerController = Get.put(PartnerController());  @override  void initState() {    // TODO: implement initState    super.initState();    controller.reportTemplateApi();  }  @override  void dispose() {    // TODO: implement dispose    super.dispose();    controller.fieldList.clear();    controller.systemGeneratedFields.clear();  }  @override  Widget build(BuildContext context) {    return Scaffold(      appBar: AppBar(title: Text("Report Template")),      body: SingleChildScrollView(        child: Obx(          () =>              controller.isLoading.value                  ? Center(child: CircularProgressIndicator())                  : Center(                    child: Padding(                      padding: const EdgeInsets.all(18.0),                      child: Column(                        children: [                          Obx(() {                            if (controller.isLoading.value) {                              return Center(child: CircularProgressIndicator());                            }                            if (controller.reportList.isEmpty ||                                controller.reportList.first.isEmpty) {                              return Text('No reports available');                            }                            // Extract unique item names (avoid duplicates)                            final List<String> itemNames =                                controller.reportList.first.map<String>((item) => item['name']?.toString().trim() ?? 'Unnamed',)                                    .toSet() // avoid duplicates                                    .toList();                            debugPrint("Dropdown Items: $itemNames");                            debugPrint("Selected Option: $selectedOption");                            // Check if selectedOption is valid                            final dropdownValue = (selectedOption != null && itemNames.contains(selectedOption!.trim(),)) ? selectedOption!.trim() : null;                            return DropdownButtonFormField<String>(                              value: dropdownValue,                              hint: Text('Select Report'),                              style: TextStyle(                                fontWeight: FontWeight.w400,                                fontSize: 14,                                color: Colors.black,                              ),                              isExpanded: true,                              decoration: InputDecoration(                                contentPadding: EdgeInsets.symmetric(                                  horizontal: 12,                                  vertical: 16,                                ),                                border: OutlineInputBorder(                                  borderRadius: BorderRadius.circular(8),                                ),                              ),                              onChanged: (String? newValue) {                                if (newValue == null) return;                                controller.clearAllFieldController();                                final selectedItem = controller.reportList.first                                    .firstWhere(                                      (item) =>                                          item['name']?.toString().trim() ==                                          newValue.trim(),                                      orElse: () => null,                                    );                                if (selectedItem != null) {                                  final reportType = selectedItem['reportType'];                                  final reportId =                                      (reportType != null &&                                              reportType is Map &&                                              reportType.containsKey('_id'))                                          ? reportType['_id'].toString()                                          : '';                                  final reason = selectedItem['reason'];                                  // Update all values                                  selectedOption = selectedItem['name'];                                  // reportTextEdit.text = selectedItem['name'];                                  controller.reportID.value = reportId;                                  controller.fieldList.clear();                                  controller.systemGeneratedFields.clear();                                  if (reason != null) {                                    controller.fieldList.addAll(                                      reason['fields'] ?? [],                                    );                                    controller.systemGeneratedFields.addAll(                                      reason['systemGeneratedFields'] ?? [],                                    );                                  }                                  log(                                    "controller.fieldList==> ${controller.fieldList}",                                  );                                  log("reportId====> $reportId");                                }                                setState(() {}); // not remove screen update                              },                              items:                                  itemNames.map((name) {                                    return DropdownMenuItem<String>(                                      value: name,                                      child: Text(                                        name,                                        style: TextStyle(fontSize: 14),                                      ),                                    );                                  }).toList(),                            );                          }),                          SizedBox(height: 20),                          if (controller.fieldList.isEmpty) ...[                            // Center(child: Text('Not Field')),                          ],                          if (controller.fieldList.isNotEmpty) ...[                            ListView.builder(                              itemCount: controller.fieldList.length,                              shrinkWrap: true,                              physics: NeverScrollableScrollPhysics(),                              itemBuilder: (context, index) {                                controller.selectOptionList.clear();                                controller.selectOptionList.add(                                  controller.fieldList[index]['options'],                                );                                log(                                  "controller.selectOptionList${controller.selectOptionList}",                                );                                List typeList =                                    controller.selectOptionList.first;                                log("typeList==> $typeList");                                return Column(                                  crossAxisAlignment: CrossAxisAlignment.start,                                  children: [                                    Text(controller.fieldList[index]['name']),                                    if (controller.fieldList[index]['type'] ==                                        "text") ...[                                      TextFormField(                                        controller:                                            controller.productNameController,                                        style: TextStyle(                                          fontWeight: FontWeight.w400,                                          fontSize: 14,                                          color: Colors.black,                                        ),                                        decoration: InputDecoration(                                          hintText: "Enter Product Name",                                          hintStyle: TextStyle(                                            fontSize: 14,                                            fontWeight: FontWeight.w400,                                          ),                                          border: OutlineInputBorder(                                            borderRadius: BorderRadius.circular(                                              15,                                            ),                                          ),                                        ),                                      ),                                      SizedBox(height: 20),                                    ],                                    if (controller.fieldList[index]['type'] ==                                        "upload") ...[                                      InkWell(                                        onTap: () async {                                          final pickedFile = await controller.pickImageFromGallery();                                          if (pickedFile != null) {                                            setState(() {});                                          }                                        },                                          child: Container(                                        height: 100,                                        width: 100,                                        decoration: DottedDecoration(                                          shape: Shape.box,                                        ),                                        child: controller.imageFile != null                                            ? Image(image: FileImage(File(controller.imageFile!.path)), fit: BoxFit.cover,) : Icon(Icons.add),)),                                      SizedBox(height: 20),                                    ],                                    if (controller.fieldList[index]['type'] ==                                        "select") ...[                                      DropdownButtonFormField<String>(                                        value: selectedValue,                                        decoration: InputDecoration(                                          // labelText: "Select Type",                                          border: OutlineInputBorder(                                            borderRadius: BorderRadius.circular(                                              15,                                            ),                                          ),                                        ),                                        style: TextStyle(                                          fontWeight: FontWeight.w400,                                          fontSize: 14,                                          color: Colors.black,                                        ),                                        items:                                            typeList.map((type) {                                              return DropdownMenuItem<String>(                                                value: type,                                                child: Text(type),                                              );                                            }).toList(),                                        onChanged: (value) {                                          setState(() {                                            selectedValue = value;                                          });                                        },                                        hint: Text("Choose a type"),                                      ),                                    ],                                  ],                                );                              },                            ),                          ],                          SizedBox(height: 20),                          if (controller.systemGeneratedFields.isNotEmpty) ...[                            ListView.builder(                              itemCount: controller.systemGeneratedFields.length,                              shrinkWrap: true,                              physics: NeverScrollableScrollPhysics(),                              itemBuilder: (context, index) {                                return Column(                                  crossAxisAlignment: CrossAxisAlignment.start,                                  children: [                                    ...List.generate(                                      controller                                          .systemGeneratedFields[index]['fields']                                          .length,                                      (fieldIndex) => Column(                                        crossAxisAlignment:                                            CrossAxisAlignment.start,                                        children: [                                          Text(                                            "${controller.systemGeneratedFields[index]['fields'][fieldIndex]}",                                          ),                                          if (controller.systemGeneratedFields[index]['fields'][fieldIndex] == "assetId") ...[                                            TextFormField(                                              controller: controller.assetsIDController,                                              style: TextStyle(                                                fontWeight: FontWeight.w400,                                                fontSize: 14,                                                color: Colors.black,                                              ),                                              decoration: InputDecoration(                                                hintText: "Enter Assets ID",                                                hintStyle: TextStyle(                                                  fontSize: 14,                                                  fontWeight: FontWeight.w400,                                                ),                                                border: OutlineInputBorder(                                                  borderRadius:                                                      BorderRadius.circular(15),                                                ),                                              ),                                            ),                                            SizedBox(height: 20),                                          ],                                          if (controller                                                  .systemGeneratedFields[index]['fields'][fieldIndex] ==                                              "assetName") ...[                                            TextFormField(                                              controller: controller.assetsNameController,                                              style: TextStyle(                                                fontWeight: FontWeight.w400,                                                fontSize: 14,                                                color: Colors.black,                                              ),                                              decoration: InputDecoration(                                                hintText: "Enter Assets Name",                                                hintStyle: TextStyle(                                                  fontSize: 14,                                                  fontWeight: FontWeight.w400,                                                ),                                                border: OutlineInputBorder(                                                  borderRadius:                                                      BorderRadius.circular(15),                                                ),                                              ),                                            ),                                            SizedBox(height: 20),                                          ],                                          if (controller                                                  .systemGeneratedFields[index]['fields'][fieldIndex] ==                                              "assetCode") ...[                                            TextFormField(                                              controller: controller.assetsCodeController,                                              style: TextStyle(                                                fontWeight: FontWeight.w400,                                                fontSize: 14,                                                color: Colors.black,                                              ),                                              decoration: InputDecoration(                                                hintText: "Enter Assets Code",                                                hintStyle: TextStyle(                                                  fontSize: 14,                                                  fontWeight: FontWeight.w400,                                                ),                                                border: OutlineInputBorder(                                                  borderRadius:                                                      BorderRadius.circular(15),                                                ),                                              ),                                            ),                                            SizedBox(height: 20),                                          ],                                          if (controller                                              .systemGeneratedFields[index]['fields'][fieldIndex] ==                                              "assetType") ...[                                            TextFormField(                                              controller:                                              controller                                                  .assetsTypeController,                                              style: TextStyle(                                                fontWeight: FontWeight.w400,                                                fontSize: 14,                                                color: Colors.black,                                              ),                                              decoration: InputDecoration(                                                hintText: "Enter Assets Type",                                                hintStyle: TextStyle(                                                  fontSize: 14,                                                  fontWeight: FontWeight.w400,                                                ),                                                border: OutlineInputBorder(                                                  borderRadius:                                                  BorderRadius.circular(15),                                                ),                                              ),                                            ),                                            SizedBox(height: 20),                                          ],                                          if (controller                                                  .systemGeneratedFields[index]['fields'][fieldIndex] ==                                              "partnerId") ...[                                            TextFormField(                                              controller: controller.partnerIDController,                                              onChanged: (value){                                                log("message");                                                setState(() {                                                  controller.getPartener(value.toString());                                                });                                              },                                              style: TextStyle(                                                fontWeight: FontWeight.w400,                                                fontSize: 14,                                                color: Colors.black,                                              ),                                              decoration: InputDecoration(                                                hintText: "Enter Partner Id",                                                hintStyle: TextStyle(                                                  fontSize: 14,                                                  fontWeight: FontWeight.w400,                                                ),                                                border: OutlineInputBorder(                                                  borderRadius:                                                      BorderRadius.circular(15),                                                ),                                              ),                                            ),                                            SizedBox(height: 20),                                          ],                                          if (controller.systemGeneratedFields[index]['fields'][fieldIndex] == "partnerName") ...[                                            TextFormField(                                              controller: controller.partnerNameController,                                              style: TextStyle(                                                fontWeight: FontWeight.w400,                                                fontSize: 14,                                                color: Colors.black,                                              ),                                              decoration: InputDecoration(                                                hintText: "Enter Partner Name",                                                hintStyle: TextStyle(                                                  fontSize: 14,                                                  fontWeight: FontWeight.w400,                                                ),                                                border: OutlineInputBorder(                                                  borderRadius:                                                      BorderRadius.circular(15),                                                ),                                              ),                                            ),                                            SizedBox(height: 20),                                          ],                                          if (controller                                              .systemGeneratedFields[index]['fields'][fieldIndex] == "partnerCategory") ...[                                            TextFormField(                                              controller: controller.partnerCategoryController,                                              style: TextStyle(                                                fontWeight: FontWeight.w400,                                                fontSize: 14,                                                color: Colors.black,                                              ),                                              decoration: InputDecoration(                                                hintText: "Enter Partner Category",                                                hintStyle: TextStyle(                                                  fontSize: 14,                                                  fontWeight: FontWeight.w400,                                                ),                                                border: OutlineInputBorder(                                                  borderRadius:                                                      BorderRadius.circular(15),                                                ),                                              ),                                            ),                                            SizedBox(height: 20),                                          ],                                          if (controller                                                  .systemGeneratedFields[index]['fields'][fieldIndex] ==                                              "pincode") ...[                                            TextFormField(                                              controller:                                                  controller.partnerPinCodeController,                                              style: TextStyle(                                                fontWeight: FontWeight.w400,                                                fontSize: 14,                                                color: Colors.black,                                              ),                                              decoration: InputDecoration(                                                hintText: "Enter pin code",                                                hintStyle: TextStyle(                                                  fontSize: 14,                                                  fontWeight: FontWeight.w400,                                                ),                                                border: OutlineInputBorder(                                                  borderRadius:                                                      BorderRadius.circular(15),                                                ),                                              ),                                            ),                                            SizedBox(height: 20),                                          ],                                        ],                                      ),                                    ),                                  ],                                );                              },                            ),                            /// create history button                            ElevatedButton(                              style: ElevatedButton.styleFrom(                                shape: RoundedRectangleBorder(                                  borderRadius: BorderRadius.circular(12),                                ),                                fixedSize: Size(                                  MediaQuery.of(context).size.width,                                  50,                                ),                              ),                              onPressed: () {},                              child: Text(                                "Create History "                                "Entry",                              ),                            ),                          ],                        ],                      ),                    ),                  ),        ),      ),    );  }}